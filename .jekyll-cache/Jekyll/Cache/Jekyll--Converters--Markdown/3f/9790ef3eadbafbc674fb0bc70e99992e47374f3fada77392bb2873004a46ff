I"K[<p>In this post, I show how to control the position of a Servomotor  <a href="http://www.ee.ic.ac.uk/pcheung/teaching/DE1_EE/stores/sg90_datasheet.pdf">SG90</a> using the BeagleBone and the library that I have been written in C++ which you can find it <a href="https://github.com/wgaonar/BeagleCPP">here</a>. The remarkable aspect is the use of the <strong>OOP</strong> paradigm to work with the SG90 servomotor.</p>

<p>The control of a servomotor position is done by means of a PWM signal with a period of <strong>20ms</strong>. The pulse width of this signal should be between 0.5ms and 2.5ms, i.e., between 2.5% and 12.5% of the duty cycle to move the servo between 0° and 180°, respectively. Figure 1 shows a diagram of the signal and its corresponding servomotor position. As you can see in that figure, when you send a pulse width of approximately 0.5ms the servo will rotate to 0° when you send 1.5ms the servo will rotate to 90°, and finally, when you send approximately 2.5ms the servo will rotate to 180°.</p>

<figure style="text-align: left; 
              width:70%; margin-left: auto; 
              margin-right: auto;">
    <img src="../assets/images/Post42/Timing.png" alt="Timing.png" width="100%" />
  <figcaption>
    Figure 1: Diagram about the pulse width and its corresponding servomotor position for 0°, 90° and 180°.
  </figcaption>
</figure>

<p>If you have another servo, it can be used as well. The difference will be in the minimum and maximum values for the pulse width. In the case of the servomotor SG90, the exact values are <strong>0.54ms and 2.5ms</strong>, in other servos, these values could be in ranges of 0.5 to 1.0ms for 0° and 2.0 to 2.5° for 180°. On the page of <a href="https://www.luisllamas.es/controlar-un-servo-con-arduino/">Luis Llamas</a>you can find a very well condensed way, general information about servomotors and how to control the SG90 with Arduino. It can be a good start point if you want to know more about it.</p>

<p>It is important to remember that the logic voltage for the BeagleBone is <font color="red">3.3V</font>. If the user provides a greater voltage, the BeagleBone could be damaged. Furthermore, if your servo is like the SG90, which needs 4.8V or more, you should provide an <font color="red">external power</font> source, wiring its ground to the BeagleBone’s ground.</p>

<h2 id="circuit-and-components">Circuit and components</h2>

<p>The circuit can be seen in Figure 2. It consists of an SG90 servomotor, 4 AA batteries, and the BeagleBone.</p>

<figure style="text-align: center; 
              margin-left: auto; 
              margin-right: auto;">
    <img src="../assets/images/Post42/Circuit.png" alt="Circuit.png" width="100%" />
  <figcaption>
    Figure 2: Circuit to control a servomotor SG90.
  </figcaption>
</figure>

<p>The components are:</p>
<ul>
  <li>1 Servomotor SG90 4.8 - 6.0V</li>
  <li>4 AA Batteries</li>
  <li>1 Protoboard mini</li>
  <li>Jumpers male-male to make the connections</li>
</ul>

<p>The PWM pin to control the servomotor is:</p>
<ul>
  <li>PWM P8_13</li>
</ul>

<h2 id="coding">Coding</h2>

<p>An <code class="language-plaintext highlighter-rouge">Servo</code> object is declared with global scope to initialize the PWM pin to control the servomotor.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c1">// Declare the SG90 object</span>
<span class="n">Servo</span> <span class="nf">myServo</span><span class="p">(</span><span class="n">P8_13</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This <code class="language-plaintext highlighter-rouge">Servo</code> object is initialized with default values of 544444 and 2500000 for the minimum and maximum pulse width, respectively. It is important to note that the pulse width units in the BeagleBone are in <font color="red">nanoseconds</font> instead of milliseconds. For this reason, these default values are used, instead of the typical values of 544 and 2500 which are in microseconds and are used in the Arduino <a href="https://www.arduino.cc/reference/en/libraries/servo/attach/">attach()</a> function.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c1">// Overload Constructor</span>
<span class="n">Servo</span><span class="o">::</span><span class="n">Servo</span> <span class="p">(</span><span class="n">PWM</span> <span class="n">newPWMPin</span><span class="p">)</span> <span class="o">:</span> <span class="n">pwmPin</span><span class="p">(</span><span class="n">newPWMPin</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">angle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">minimumPulseWidth</span> <span class="o">=</span> <span class="mi">544444</span><span class="p">;</span>
  <span class="n">maximumPulseWidth</span> <span class="o">=</span> <span class="mi">2500000</span><span class="p">;</span>

  <span class="k">this</span><span class="o">-&gt;</span><span class="n">InitServo</span><span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="c1">// Private method to set the Servo period for the PWM pin </span>
<span class="kt">void</span> <span class="n">Servo</span><span class="o">::</span><span class="n">InitServo</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// Set the period of Servo in ns</span>
  <span class="n">pwmPin</span><span class="p">.</span><span class="n">SetPeriod</span><span class="p">(</span><span class="n">ServoPeriod</span><span class="p">);</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">message</span><span class="p">;</span>
  <span class="n">message</span> <span class="o">=</span> <span class="s">"</span><span class="se">\n</span><span class="s">Servo object with the next parameters / pins was created:</span><span class="se">\n</span><span class="s">"</span> <span class="o">+</span>
            <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">PWM Pin: "</span><span class="p">)</span> <span class="o">+</span> 
            <span class="k">this</span><span class="o">-&gt;</span><span class="n">pwmPin</span><span class="p">.</span><span class="n">GetPinHeaderId</span><span class="p">()</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span> <span class="o">+</span>
            <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">PWM Period: "</span><span class="p">)</span> <span class="o">+</span> 
            <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">pwmPin</span><span class="p">.</span><span class="n">GetPeriod</span><span class="p">())</span> <span class="o">+</span> <span class="s">"ns</span><span class="se">\n</span><span class="s">"</span> <span class="o">+</span>
            <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">Minimum Pulse Width: "</span><span class="p">)</span> <span class="o">+</span> 
            <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">GetMinimumPulseWidth</span><span class="p">())</span> <span class="o">+</span> <span class="s">"ns</span><span class="se">\n</span><span class="s">"</span> <span class="o">+</span>
            <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">Maximum Pulse Width: "</span><span class="p">)</span> <span class="o">+</span> 
            <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">GetMaximumPulseWidth</span><span class="p">())</span> <span class="o">+</span> <span class="s">"ns</span><span class="se">\n\n</span><span class="s">"</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">RainbowText</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s">"Light Blue"</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Finally, the period for the PWM signal is declared and initialized to a constant value of 20000000 (instead of 20) inside the class. The next listings show the constructor for this <code class="language-plaintext highlighter-rouge">Servo</code> object:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="cm">/* The standard period of 20ms to control any servo */</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">ServoPeriod</span> <span class="o">=</span> <span class="mi">20000000</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>To rotate the servo you can use the <code class="language-plaintext highlighter-rouge">SetAngle()</code> method which receives the angle en degrees and makes the mapping between this value to the corresponding pulse width. After that, this mapped value is sent to the PWM pin.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="cm">/*
  Public method to set the speed rotation
  @param int: the desired angle (0-180)     
*/</span>
<span class="kt">void</span> <span class="n">Servo</span><span class="o">::</span><span class="n">SetAngle</span><span class="p">(</span><span class="kt">int</span> <span class="n">newAngle</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">angle</span> <span class="o">=</span> <span class="n">newAngle</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">mapping</span> <span class="o">=</span> <span class="p">(</span><span class="n">maximumPulseWidth</span><span class="o">-</span><span class="n">minimumPulseWidth</span><span class="p">)</span><span class="o">/</span><span class="mf">180.0</span> <span class="o">*</span> <span class="n">angle</span> <span class="o">+</span> <span class="n">minimumPulseWidth</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">pulseWidth</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
  <span class="n">pwmPin</span><span class="p">.</span><span class="n">SetDutyCycleByPeriod</span><span class="p">(</span><span class="n">pulseWidth</span><span class="p">);</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">message</span><span class="p">;</span>
  <span class="n">message</span> <span class="o">=</span> <span class="s">"angle: "</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">+</span> <span class="s">" -&gt; pulse width: "</span> <span class="o">+</span>
            <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">pulseWidth</span><span class="p">)</span> <span class="o">+</span> <span class="s">"ns</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">RainbowText</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s">"Light Blue"</span><span class="p">);</span> 
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This mapping is a linear function that takes the angle and returns the corresponding pulse width taking into account the minimum and maximum pulse width values defined when the <code class="language-plaintext highlighter-rouge">SG90</code> object is constructed at the begging of code. The graph of this mapping can be seen in Figure 3.</p>

<figure style="text-align: center; 
              width: 100%; margin-left: auto; 
              margin-right: auto;">
    <img src="../assets/images/Post42/Mapping.png" alt="Mapping.png" width="100%" />
  <figcaption>
    Figure 3: Mapping between the angle and the pulse width for the servomotor SG90.
  </figcaption>
</figure>

<p>In order to make a sweep with the servomotor, two <code class="language-plaintext highlighter-rouge">for loops</code> can be used in both directions, from 0° to 180° and vice versa, giving a delay of 1000ms to observe the movement and giving to the servomotor more than enough time to reach the desired angle.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="c1">// Sweep from 0-180</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">angle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">angle</span> <span class="o">&lt;=</span> <span class="mi">180</span><span class="p">;</span> <span class="n">angle</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">myServo</span><span class="p">.</span><span class="n">SetAngle</span><span class="p">(</span><span class="n">angle</span><span class="p">);</span>
  <span class="n">Delayms</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>  <span class="c1">// Wait 1000ms for the servo to reach the position</span>
<span class="p">}</span>

<span class="c1">// Sweep from 180-0</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">angle</span> <span class="o">=</span> <span class="mi">180</span><span class="p">;</span> <span class="n">angle</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">angle</span> <span class="o">-=</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">myServo</span><span class="p">.</span><span class="n">SetAngle</span><span class="p">(</span><span class="n">angle</span><span class="p">);</span>
  <span class="n">Delayms</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>  <span class="c1">// Wait 1000ms for the servo to reach the position</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The complete code for this implementation is shown in the next listing:</p>

<h3 id="sg90_11cpp">SG90_1.1.cpp</h3>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="cm">/******************************************************************************
SG90_1.1.cpp
@wgaonar
21/07/2021
https://github.com/wgaonar/BeagleCPP

- Sweep a Servomotor 

Class: Servo
******************************************************************************/</span>
<span class="cp">#include &lt;iostream&gt;
#include "../../../Sources/Servo.h"
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="c1">// Declare the Servo object</span>
<span class="n">Servo</span> <span class="nf">myServo</span><span class="p">(</span><span class="n">P8_13</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">string</span> <span class="n">message</span> <span class="o">=</span> <span class="s">"Main program starting here..."</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">RainbowText</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="s">"Blue"</span><span class="p">,</span> <span class="s">"White"</span><span class="p">,</span> <span class="s">"Bold"</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

  <span class="c1">// Sweep from 0-180</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">angle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">angle</span> <span class="o">&lt;=</span> <span class="mi">180</span><span class="p">;</span> <span class="n">angle</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">myServo</span><span class="p">.</span><span class="n">SetAngle</span><span class="p">(</span><span class="n">angle</span><span class="p">);</span>
    <span class="n">Delayms</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>  <span class="c1">// Wait 1000ms for the servo to reach the position</span>
  <span class="p">}</span>

  <span class="c1">// Sweep from 180-0</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">angle</span> <span class="o">=</span> <span class="mi">180</span><span class="p">;</span> <span class="n">angle</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">angle</span> <span class="o">-=</span> <span class="mi">10</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">myServo</span><span class="p">.</span><span class="n">SetAngle</span><span class="p">(</span><span class="n">angle</span><span class="p">);</span>
    <span class="n">Delayms</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>  <span class="c1">// Wait 1000ms for the servo to reach the position</span>
  <span class="p">}</span>
  
  <span class="n">message</span> <span class="o">=</span> <span class="s">"Main program finishes here..."</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">RainbowText</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="s">"Blue"</span><span class="p">,</span> <span class="s">"White"</span><span class="p">,</span><span class="s">"Bold"</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>To check the pulse width that is sent by the BeagleBone to the servomotor, it has been captured with an oscilloscope at 0°, 90°, and 180°. These pictures are shown in hte next set of figures:</p>

<style>
/* Three image containers (use 25% for four, and 50% for two, etc) */
.column {
  float: left;
  width: 50%;
  padding: 2%;
}
</style>

<div class="row">
  <div class="column">
    <figure style="text-align: justify;">
      <img src="../assets/images/Post42/0degrees-a.png" alt="0degrees-a.png" style="width:100%" />
      <figcaption>
        Figure 4a: The signal for 0° with a period of 20ms. 
      </figcaption>
    </figure>
  </div>
  <div class="column">
    <figure style="text-align: justify;">
      <img src="../assets/images/Post42/0degrees-b.png" alt="0degrees-b.png" style="width:100%" />
      <figcaption>
        Figure 4b: The theoretical pulse width for 0° of 520ms (544444ns exactly).  
      </figcaption>
    </figure>
  </div>
</div>

<div class="row">
  <div class="column">
    <figure style="text-align: justify;">
      <img src="../assets/images/Post42/90degrees-a.png" alt="90degrees-a.png" style="width:100%" />
      <figcaption>
        Figure 5a: The signal for 90° with a period of 20ms. 
      </figcaption>
    </figure>
  </div>
  <div class="column">
    <figure>
      <img src="../assets/images/Post42/90degrees-b.png" alt="90degrees-b.png" style="width:100%" />
      <figcaption>
        Figure 5b: The theoretical pulse width for 90° of 1.5ms (1500000ns exactly).  
      </figcaption>
    </figure>
  </div>
</div>

<div class="row">
  <div class="column">
    <figure style="text-align: justify;">
      <img src="../assets/images/Post42/180degrees-a.png" alt="180degrees-a.png" style="width:100%" />
      <figcaption>
        Figure 6a: The signal for 180° with a period of 20ms.
      </figcaption>
    </figure>
  </div>
  <div class="column">
    <figure>
      <img src="../assets/images/Post42/180degrees-b.png" alt="180degrees-b.png" style="width:100%" />
      <figcaption>
        Figure 6b: The theoretical pulse width for 180° of 2.5ms (2520000ns exactly).
      </figcaption>
    </figure>
  </div>
</div>

<h3 id="execution-of-the-program">Execution of the program:</h3>
<figure style="text-align: center; width:100%; 
              margin-left: auto; 
              margin-right: auto;">
  <video width="100%" controls="" poster="../assets/images/Post42/VideoCover-SG90_1.1.png">
    <source src="../assets/images/Post42/SG90_1.1.mp4" type="video/mp4" />
  </video>
  <figcaption>
    Video: Execution of the program.
  </figcaption>
</figure>

<p>Se you in the next post.</p>
:ET