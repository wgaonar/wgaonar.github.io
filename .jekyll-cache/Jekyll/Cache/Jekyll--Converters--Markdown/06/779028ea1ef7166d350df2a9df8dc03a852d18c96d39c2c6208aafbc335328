I"N<p>In this post, I show how to control the speed of the <font color="red">360° continuous rotation</font> servomotor <a href="https://www.sparkfun.com/datasheets/Robotics/servo-360_e.pdf">SM-S4303R</a> which can run to 60rpm if the servomotor is powered with 4.8V or 70rpm if it is powered with6.0V.</p>

<p>In this work, these absolute values for the speed will not be used, instead, the speed wil be computed in percentage ranging from <font color="red">-100</font> for the maximum speed in the <font color="red">counterclockwise</font> direction and <font color="blue">100%</font> for the maximum speed in the <font color="blue">clockwise</font> direction.</p>

<p>The control will be done through a potentiometer using the BeagleBone and the library that I have been written in C++ which you can find <a href="https://github.com/wgaonar/BeagleCPP">here</a>.  In the <a href="/Post44-BeagleBone_SG90_ADC/">last post</a>, I showed the technical details about how to control the position from a potentiometer. In this case, I use the potentiometer too, but to control the speed of the 360° SM-S4303R continuos rotation servomotor instead of the angle of a 180° SG-90 servomotor</p>

<p>It is important to remember that the logic voltage for the BeagleBone is <font color="red">3.3V</font>. If the user provides a greater voltage, the BeagleBone could be damaged. Furthermore, if your servo is like the SM-S4303R, which needs 4.8V or more, you should provide an <font color="red">external power</font> source, wiring its ground to the BeagleBone’s ground.</p>

<h2 id="circuit-and-components">Circuit and components</h2>

<p>The circuit can be seen in Figure 1. It consists of an SM-S4303R servomotor, 1 Potentiometer, 4 AA batteries, and the BeagleBone.</p>

<figure style="text-align: center; 
              margin-left: auto; 
              margin-right: auto;">
    <img src="../assets/images/Post45/Circuit.png" alt="Circuit.png" width="100%" />
  <figcaption>
    Figure 1: Circuit to control the speed of a 360° continuous rotation servomotor SM-S4303R.
  </figcaption>
</figure>

<p>The components are:</p>
<ul>
  <li>1 Servomotor SM-S4303R 4.8 - 6.0V</li>
  <li>4 AA Batteries</li>
  <li>1 Protoboard mini</li>
  <li>Jumpers male-male to make the connections</li>
</ul>

<p>The PWM pin to control the servomotor is:</p>
<ul>
  <li>PWM P8_13</li>
</ul>

<h2 id="codingh1">Coding&lt;/h1&gt;</h2>

<p>Some <code class="language-plaintext highlighter-rouge">Servo</code> and <code class="language-plaintext highlighter-rouge">ADC</code> objects are declared with global scope to initialize the servomotor and the pin from which the potentiometer will be attached to.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1">// Declare the Servo object</span>
<span class="n">Servo</span> <span class="nf">myServo</span><span class="p">(</span><span class="n">P8_13</span><span class="p">);</span>

<span class="c1">// Declare the ADC pin to attach the potentiometer</span>
<span class="n">ADC</span> <span class="nf">myPotentiometer</span><span class="p">(</span><span class="n">P9_39</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This <code class="language-plaintext highlighter-rouge">Servo</code> object is initialized with default values of 544444 and 2500000 for the minimum and maximum pulse width, respectively. It is important to note that the pulse width units in the BeagleBone are in <font color="red">nanoseconds</font> instead of milliseconds. For this reason, these default values are used, instead of the typical values of 544 and 2500 which are in microseconds and are used in the Arduino <a href="https://www.arduino.cc/reference/en/libraries/servo/attach/">attach()</a> function.</p>

<p>Three global variables are defined and initialized to disable the servo movement, store the reading coming from the potentiometer, and store the desired speed, respectively.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="c1">// Global variables</span>
<span class="kt">bool</span> <span class="n">stopMoveServo</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">adcValueOut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>To control the servomotor speed from the potentiometer, the <code class="language-plaintext highlighter-rouge">ReadADC()</code> method is used and store in the <code class="language-plaintext highlighter-rouge">adcValueOut</code> variable. Then, this value which is between 0 - 4095, is mapped to the range of the servomotor speed, i.e. -100% - 100%, and store in the <code class="language-plaintext highlighter-rouge">speed</code> variable.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1">// Read the analog converted value</span>
<span class="n">adcValueOut</span> <span class="o">=</span> <span class="n">myPotentiometer</span><span class="p">.</span><span class="n">ReadADC</span><span class="p">();</span>

<span class="c1">// Map the adc value to the speed</span>
<span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">adcValueOut</span> <span class="o">-</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4095.0</span> <span class="o">*</span> <span class="mi">200</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This mapping is a linear function that takes the ADC value from the potentiometer and returns the corresponding speed, taking into account the clockwise and counterclockwise direction. The graph of this mapping can be seen in Figure 2.</p>

<figure style="text-align: center; 
              width: 100%; margin-left: auto; 
              margin-right: auto;">
    <img src="../assets/images/Post45/MappingSpeedADC.png" alt="MappingSpeed.png" width="100%" />
  <figcaption>
    Figure 2: Mapping between the potentiometer reading and the speed for the 360° continuous rotation servomotor SM-S4303R. The green area corresponds to the clockwise direction while the red area to counterclockwise.
  </figcaption>
</figure>

<p>To rotate the servo you can use the <code class="language-plaintext highlighter-rouge">SetSpeed()</code> method which receives the speed in percentage in a range from -100 to 100 and delivers the corresponding pulse width in a range from the minimum and maximum pulse width for the servomotor. In this case, the default values of the class are 544444ns and 2500000ns, respectively. The positive speed values correspond to the clockwise direction and the negative values to the counterclockwise</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c1">// Move the servo</span>
<span class="n">myServo</span><span class="p">.</span><span class="n">SetSpeed</span><span class="p">(</span><span class="n">speed</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The implementation of this method in the class <code class="language-plaintext highlighter-rouge">Servo</code> can be shown in the next listing where can be observed the equation which does the mapping between the desired speed and the corresponding pulse width.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="cm">/*
Public method to set the speed for a continuous servo
@param int: the desired angle (-100-100)     
*/</span>
<span class="kt">void</span> <span class="n">Servo</span><span class="o">::</span><span class="n">SetSpeed</span><span class="p">(</span><span class="kt">int</span> <span class="n">newSpeed</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">speed</span> <span class="o">=</span> <span class="n">newSpeed</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">averagePulseWidth</span> <span class="o">=</span> <span class="p">(</span><span class="n">maximumPulseWidth</span><span class="o">-</span><span class="n">minimumPulseWidth</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">minimumPulseWidth</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">mapping</span> <span class="o">=</span> <span class="p">(</span><span class="n">maximumPulseWidth</span><span class="o">-</span><span class="n">minimumPulseWidth</span><span class="p">)</span><span class="o">/</span><span class="mf">200.0</span> <span class="o">*</span> <span class="n">speed</span> <span class="o">+</span> <span class="n">averagePulseWidth</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">pulseWidth</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
  <span class="n">pwmPin</span><span class="p">.</span><span class="n">SetDutyCycleByPeriod</span><span class="p">(</span><span class="n">pulseWidth</span><span class="p">);</span>
  
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">message</span><span class="p">;</span>
  <span class="n">message</span> <span class="o">=</span> <span class="s">"speed: "</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span> <span class="o">+</span> <span class="s">" -&gt; pulse width: "</span> <span class="o">+</span>
  <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">pulseWidth</span><span class="p">)</span> <span class="o">+</span> <span class="s">"ns</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">RainbowText</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s">"Light Blue"</span><span class="p">);</span> 
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This mapping can be seen in Figure 3 where a linear function takes the speed and returns the corresponding pulse width.</p>

<figure style="text-align: center; 
              width: 100%; margin-left: auto; 
              margin-right: auto;">
    <img src="../assets/images/Post45/MappingPulseWidthSpeed.png" alt="MappingPulseWidth.png" width="100%" />
  <figcaption>
    Figure 3: Mapping between the Pulse Width and the Speed for the 360° continuous rotation servomotor SM-S4303R. The green area corresponds to the clockwise direction while the red area to counterclockwise.
  </figcaption>
</figure>

<p>The lines of code that read the potentiometer and move the servo are inside of a callback function to do these processes in the background while the <code class="language-plaintext highlighter-rouge">stopMoveServo</code> variable will be <code class="language-plaintext highlighter-rouge">true</code>. This callback function is activated on the <code class="language-plaintext highlighter-rouge">ADC</code> object, in this case, through the <code class="language-plaintext highlighter-rouge">myPotentiometer</code> object with this line:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c1">// Activate the ADC object's callback function</span>
<span class="n">myPotentiometer</span><span class="p">.</span><span class="n">DoUserFunction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MoveServo</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The complete code for this implementation is shown in the next listing:</p>

<h3 id="sm-s4303r_11cpp">SM-S4303R_1.1.cpp</h3>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre></td><td class="rouge-code"><pre><span class="cm">/******************************************************************************
SM-S4303R_1.1.cpp
@wgaonar
31/07/2021
https://github.com/wgaonar/BeagleCPP

- Move a continuous rotation servo with the readings from a potentiometer

Class: Servo
******************************************************************************/</span>
<span class="cp">#include &lt;iostream&gt;
#include "../../../Sources/Servo.h"
#include "../../../Sources/ADC.h"
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="c1">// Declare the Servo object</span>
<span class="n">Servo</span> <span class="nf">myServo</span><span class="p">(</span><span class="n">P8_13</span><span class="p">);</span>

<span class="c1">// Declare the ADC pin to attach the potentiometer</span>
<span class="n">ADC</span> <span class="nf">myPotentiometer</span><span class="p">(</span><span class="n">P9_39</span><span class="p">);</span>

<span class="c1">// Global variables</span>
<span class="kt">bool</span> <span class="n">stopMoveServo</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">adcValueOut</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// Function to move the servo in background</span>
<span class="kt">int</span> <span class="nf">MoveServo</span><span class="p">()</span> 
<span class="p">{</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">stopMoveServo</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Read the analog converted value</span>
    <span class="n">adcValueOut</span> <span class="o">=</span> <span class="n">myPotentiometer</span><span class="p">.</span><span class="n">ReadADC</span><span class="p">();</span>

    <span class="c1">// Map the adc value to the speed</span>
    <span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">adcValueOut</span> <span class="o">-</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4095.0</span> <span class="o">*</span> <span class="mi">200</span><span class="p">;</span>

    <span class="c1">// Move the servo</span>
    <span class="n">myServo</span><span class="p">.</span><span class="n">SetSpeed</span><span class="p">(</span><span class="n">speed</span><span class="p">);</span>

    <span class="n">Delayms</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">string</span> <span class="n">message</span> <span class="o">=</span> <span class="s">"Main program starting here..."</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">RainbowText</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="s">"Blue"</span><span class="p">,</span> <span class="s">"White"</span><span class="p">,</span> <span class="s">"Bold"</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

  <span class="c1">// Activate the ADC object's callback function</span>
  <span class="n">myPotentiometer</span><span class="p">.</span><span class="n">DoUserFunction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MoveServo</span><span class="p">);</span>

  <span class="kt">char</span> <span class="n">userInput</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">userInput</span> <span class="o">!=</span> <span class="sc">'y'</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s">"Enter an option 'y' for exit: "</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">RainbowText</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s">"Blue"</span><span class="p">);</span>
    
    <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">userInput</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">userInput</span> <span class="o">==</span> <span class="sc">'y'</span><span class="p">)</span> 
      <span class="n">stopMoveServo</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="n">message</span> <span class="o">=</span> <span class="s">"Main program finishes here..."</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">RainbowText</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="s">"Blue"</span><span class="p">,</span> <span class="s">"White"</span><span class="p">,</span><span class="s">"Bold"</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="execution-of-the-program">Execution of the program:</h3>
<figure style="text-align: center; width:100%; 
              margin-left: auto; 
              margin-right: auto;">
  <video width="100%" controls="" poster="../assets/images/Post45/VideoCover-SM-S4303R_1.1.png">
    <source src="../assets/images/Post45/SM-S4303R_1.1.mp4" type="video/mp4" />
  </video>
  <figcaption>
    Video: Execution of the program.
  </figcaption>
</figure>

<p>Se you in the next post.</p>
:ET